// Enhanced Prisma Schema - Real-World Sales & Inventory System
// Includes: Customer Management, Discounts, Images, Invoices, Returns, Multi-Branch

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = "file:./dev.db"
}

model User {
  id        String   @id @default(cuid())
  username  String   @unique
  password  String
  fullName  String
  email     String?
  role      String   // ADMIN, CASHIER, INVENTORY_CLERK
  branchId  String?  // For multi-branch
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  branch    Branch?   @relation(fields: [branchId], references: [id])
  sales     Sale[]
  purchases Purchase[]
  invoices  Invoice[]
  returns   Return[]
  activityLogs ActivityLog[]

  @@map("users")
}

model Branch {
  id          String   @id @default(cuid())
  name        String
  code        String   @unique
  address     String?
  phone       String?
  email       String?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  users     User[]
  products  Product[]
  sales     Sale[]
  purchases Purchase[]
  transfers StockTransfer[] @relation("FromBranch")
  receivedTransfers StockTransfer[] @relation("ToBranch")

  @@map("branches")
}

model Category {
  id          String    @id @default(cuid())
  name        String    @unique
  description String?
  imageUrl    String?
  isActive    Boolean   @default(true)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  products Product[]

  @@map("categories")
}

model Supplier {
  id             String    @id @default(cuid())
  companyName    String
  contactPerson  String
  email          String?
  phone          String
  address        String?
  taxId          String?
  paymentTerms   String?   // "Net 30", "Net 60", etc.
  isActive       Boolean   @default(true)
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  products  Product[]
  purchases Purchase[]

  @@map("suppliers")
}

model Customer {
  id             String    @id @default(cuid())
  customerNumber String    @unique
  name           String
  email          String?
  phone          String?
  address        String?
  dateOfBirth    DateTime?
  customerType   String    @default("REGULAR") // REGULAR, VIP, WHOLESALE
  loyaltyPoints  Int       @default(0)
  storeCredit    Float     @default(0)
  notes          String?
  isActive       Boolean   @default(true)
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  sales    Sale[]
  invoices Invoice[]
  returns  Return[]

  @@map("customers")
}

model Product {
  id            String   @id @default(cuid())
  code          String   @unique
  barcode       String?  @unique
  name          String
  description   String?
  categoryId    String
  supplierId    String
  branchId      String?
  unitPrice     Float
  costPrice     Float    @default(0)
  stockLevel    Int      @default(0)
  reorderLevel  Int      @default(10)
  imageUrl      String?
  weight        Float?
  dimensions    String?  // "10x20x30 cm"
  expiryDate    DateTime?
  batchNumber   String?
  taxRate       Float    @default(0)
  isActive      Boolean  @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  category        Category         @relation(fields: [categoryId], references: [id])
  supplier        Supplier         @relation(fields: [supplierId], references: [id])
  branch          Branch?          @relation(fields: [branchId], references: [id])
  saleItems       SaleItem[]
  purchaseItems   PurchaseItem[]
  invoiceItems    InvoiceItem[]
  returnItems     ReturnItem[]
  transferItems   StockTransferItem[]

  @@map("products")
}

model Sale {
  id             String   @id @default(cuid())
  saleNumber     String   @unique
  userId         String
  customerId     String?
  branchId       String?
  totalAmount    Float
  taxAmount      Float    @default(0)
  discountAmount Float    @default(0)
  netAmount      Float
  paymentMethod  String   @default("CASH") // CASH, CARD, GCASH, PAYMAYA
  paymentStatus  String   @default("PAID") // PAID, PARTIAL, PENDING
  notes          String?
  createdAt      DateTime @default(now())

  user         User          @relation(fields: [userId], references: [id])
  customer     Customer?     @relation(fields: [customerId], references: [id])
  branch       Branch?       @relation(fields: [branchId], references: [id])
  saleItems    SaleItem[]
  discounts    SaleDiscount[]
  returns      Return[]

  @@map("sales")
}

model SaleItem {
  id             String @id @default(cuid())
  saleId         String
  productId      String
  quantity       Int
  unitPrice      Float
  discountAmount Float  @default(0)
  taxAmount      Float  @default(0)
  subtotal       Float

  sale    Sale    @relation(fields: [saleId], references: [id], onDelete: Cascade)
  product Product @relation(fields: [productId], references: [id])

  @@map("sale_items")
}

model Discount {
  id              String   @id @default(cuid())
  code            String   @unique
  name            String
  description     String?
  discountType    String   // PERCENTAGE, FIXED_AMOUNT, BUY_X_GET_Y
  discountValue   Float
  minPurchase     Float    @default(0)
  maxDiscount     Float?
  startDate       DateTime
  endDate         DateTime
  usageLimit      Int?
  usageCount      Int      @default(0)
  applicableFor   String   @default("ALL") // ALL, CATEGORY, PRODUCT, CUSTOMER_TYPE
  isActive        Boolean  @default(true)
  createdAt       DateTime @default(now())

  saleDiscounts SaleDiscount[]

  @@map("discounts")
}

model SaleDiscount {
  id             String @id @default(cuid())
  saleId         String
  discountId     String
  discountAmount Float

  sale     Sale     @relation(fields: [saleId], references: [id], onDelete: Cascade)
  discount Discount @relation(fields: [discountId], references: [id])

  @@map("sale_discounts")
}

model Invoice {
  id            String   @id @default(cuid())
  invoiceNumber String   @unique
  customerId    String
  userId        String
  issueDate     DateTime @default(now())
  dueDate       DateTime
  totalAmount   Float
  taxAmount     Float    @default(0)
  discountAmount Float   @default(0)
  netAmount     Float
  paidAmount    Float    @default(0)
  status        String   @default("PENDING") // PENDING, PAID, OVERDUE, CANCELLED
  paymentTerms  String?  // "Net 30 days"
  notes         String?
  createdAt     DateTime @default(now())

  customer     Customer      @relation(fields: [customerId], references: [id])
  user         User          @relation(fields: [userId], references: [id])
  invoiceItems InvoiceItem[]

  @@map("invoices")
}

model InvoiceItem {
  id        String @id @default(cuid())
  invoiceId String
  productId String
  quantity  Int
  unitPrice Float
  subtotal  Float

  invoice Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  product Product @relation(fields: [productId], references: [id])

  @@map("invoice_items")
}

model Return {
  id           String   @id @default(cuid())
  returnNumber String   @unique
  saleId       String?
  customerId   String?
  userId       String
  totalAmount  Float
  refundMethod String   @default("CASH") // CASH, CARD, STORE_CREDIT
  reason       String?
  status       String   @default("PENDING") // PENDING, APPROVED, REJECTED
  notes        String?
  createdAt    DateTime @default(now())

  sale        Sale?        @relation(fields: [saleId], references: [id])
  customer    Customer?    @relation(fields: [customerId], references: [id])
  user        User         @relation(fields: [userId], references: [id])
  returnItems ReturnItem[]

  @@map("returns")
}

model ReturnItem {
  id        String @id @default(cuid())
  returnId  String
  productId String
  quantity  Int
  unitPrice Float
  subtotal  Float
  condition String @default("RESELLABLE") // RESELLABLE, DAMAGED, DEFECTIVE

  return  Return  @relation(fields: [returnId], references: [id], onDelete: Cascade)
  product Product @relation(fields: [productId], references: [id])

  @@map("return_items")
}

model Purchase {
  id             String   @id @default(cuid())
  purchaseNumber String   @unique
  userId         String
  supplierId     String
  branchId       String?
  totalAmount    Float
  taxAmount      Float    @default(0)
  shippingCost   Float    @default(0)
  status         String   @default("RECEIVED") // PENDING, RECEIVED, CANCELLED
  notes          String?
  createdAt      DateTime @default(now())

  user          User           @relation(fields: [userId], references: [id])
  supplier      Supplier       @relation(fields: [supplierId], references: [id])
  branch        Branch?        @relation(fields: [branchId], references: [id])
  purchaseItems PurchaseItem[]

  @@map("purchases")
}

model PurchaseItem {
  id         String @id @default(cuid())
  purchaseId String
  productId  String
  quantity   Int
  unitCost   Float
  subtotal   Float

  purchase Purchase @relation(fields: [purchaseId], references: [id], onDelete: Cascade)
  product  Product  @relation(fields: [productId], references: [id])

  @@map("purchase_items")
}

model StockTransfer {
  id             String   @id @default(cuid())
  transferNumber String   @unique
  fromBranchId   String
  toBranchId     String
  status         String   @default("PENDING") // PENDING, IN_TRANSIT, RECEIVED, CANCELLED
  notes          String?
  createdAt      DateTime @default(now())
  receivedAt     DateTime?

  fromBranch    Branch              @relation("FromBranch", fields: [fromBranchId], references: [id])
  toBranch      Branch              @relation("ToBranch", fields: [toBranchId], references: [id])
  transferItems StockTransferItem[]

  @@map("stock_transfers")
}

model StockTransferItem {
  id         String @id @default(cuid())
  transferId String
  productId  String
  quantity   Int

  transfer StockTransfer @relation(fields: [transferId], references: [id], onDelete: Cascade)
  product  Product       @relation(fields: [productId], references: [id])

  @@map("stock_transfer_items")
}

model ActivityLog {
  id          String   @id @default(cuid())
  userId      String
  action      String   // CREATE, UPDATE, DELETE, LOGIN, LOGOUT
  entityType  String   // PRODUCT, SALE, PURCHASE, USER, etc.
  entityId    String?
  description String
  ipAddress   String?
  userAgent   String?
  createdAt   DateTime @default(now())

  user User @relation(fields: [userId], references: [id])

  @@map("activity_logs")
}

model EmailLog {
  id          String   @id @default(cuid())
  recipient   String
  subject     String
  body        String
  status      String   @default("PENDING") // PENDING, SENT, FAILED
  sentAt      DateTime?
  error       String?
  createdAt   DateTime @default(now())

  @@map("email_logs")
}